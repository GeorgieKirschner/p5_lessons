<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Giphy Memory Game</title>
</head>

<body>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.14/p5.js"></script>
</body>

<script type="text/javascript">
  /* 1. Load car images from the Giphy API
          - Create loading text while Giphy images are not loaded yet
     * 2. Display all images in a grid format
     */

  let giphyImages = null;
  let imageSize = 300;
  let paddingSize = 10;
  let x = 0;
  let y = 0;

  var tiles = [];
  var flippedTiles = [];
  var delayStartFC = null;

  var possibleFaces = [];
  var selected = [];

  function preload() {  // preload() runs once

    // stub together API call url
    let url = 'http://api.giphy.com/v1/gifs/search?q=cars&' +
      'api_key=1aad8150a8f2496cae0414b3f8d35622' +
      '&limit=10';

    // HTTP POST request (API call)
    httpGet(url, "json", false, function (response) {
      giphyImages = response.data;
    });

  }

  function setup() {
    createCanvas(1200, 800);
  }

  function draw() {

    // check if API call has completed yet
    if (!giphyImages) {

      /* if not - display loading text and
       * and exit function -> recheck on nect draw call()
       */
      textSize(32);
      text('Loading...', 10, 30)
      return;
    }

    for (var i = 0; i < 10; i++) {
      // Push 2 copies onto array
      var imageUrl = giphyImages[i].images.downsized.url;
      selected.push(imageUrl);
      selected.push(imageUrl);
    }

    // Now we need to randomize the array
    selected.sort(function () {
      return 0.5 - Math.random();
    });

    // Create the tiles
    for (var i = 0; i < 5; i++) {
      for (var j = 0; j < 4; j++) {
        tiles.push(new Tile(i * 78 + 10, j * 78 + 40, selected.pop()));
      }
    }

    // Now draw them face up
    for (var i = 0; i < tiles.length; i++) {
      tiles[i].drawFaceDown();
    }

    noLoop(); // stop draw
  } // end draw()

  var Tile = function (x, y, face) {
    this.x = x;
    this.y = y;
    this.face = face;
    this.width = 70;
  };

  Tile.prototype.drawFaceDown = function () {
    fill(214, 247, 202);
    strokeWeight(2);
    rect(this.x, this.y, this.width, this.width);
    this.isFaceUp = false;
  };

  Tile.prototype.drawFaceDown = function () {
    fill(214, 247, 202);
    strokeWeight(2);
    rect(this.x, this.y, this.width, this.width);
    this.isFaceUp = false;
  };

  Tile.prototype.drawFaceUp = function () {
    var that = this;
    loadImage(this.face, function (img) {
        image(img, that.x, that.y, that.width, that.width);
    });
    this.isFaceUp = true;
  };

  Tile.prototype.isUnderMouse = function (x, y) {
    return x >= this.x && x <= this.x + this.width &&
      y >= this.y && y <= this.y + this.width;
  };

  function mousePressed() {
    //debugger;
    for (var i = 0; i < tiles.length; i++) {
      if (tiles[i].isUnderMouse(mouseX, mouseY)) {
        if (flippedTiles.length < 2 && !tiles[i].isFaceUp) {
          tiles[i].drawFaceUp();
          flippedTiles.push(tiles[i]);
          if (flippedTiles.length === 2) {
            if (new String(flippedTiles[0].face).valueOf() === new String(flippedTiles[1].face).valueOf()) {
              flippedTiles=[];
            }
            else {
              //setTimeout(function() { 
                flippedTiles[0].drawFaceDown();
                flippedTiles[1].drawFaceDown();
                flippedTiles = [];
              //}, 300);
            }

          }
        }
      }
    }
  }

</script>

</html>